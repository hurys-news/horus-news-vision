# دليل تصحيح مشاكل المصادقة في حورس نيوز

هذا الدليل يساعدك في تشخيص وحل مشاكل المصادقة في مشروع حورس نيوز.

## المشاكل الشائعة

### 1. مشكلة "تسجيل الدخول يدور ولا يدخل"

هذه المشكلة تحدث عندما يحاول المستخدم تسجيل الدخول ولكن العملية لا تكتمل. هناك عدة أسباب محتملة:

#### أ. متغيرات البيئة غير صحيحة

تأكد من وجود متغيرات البيئة التالية في Vercel:

- `VITE_SUPABASE_URL`: عنوان URL لمشروع Supabase
- `VITE_SUPABASE_ANON_KEY`: المفتاح المجهول (anon key) لمشروع Supabase

يمكنك التحقق من هذه المتغيرات من خلال:

1. الذهاب إلى لوحة تحكم Vercel
2. اختيار مشروعك
3. النقر على "Settings" > "Environment Variables"

#### ب. إعدادات CORS غير صحيحة

تأكد من إضافة عنوان موقعك إلى قائمة "Allowed Origins" في إعدادات CORS في Supabase:

1. انتقل إلى لوحة تحكم Supabase
2. انقر على "Settings" > "API"
3. في قسم "CORS", تأكد من إضافة عنوان موقعك (مثل: `https://horusnews.vercel.app`) إلى قائمة "Allowed Origins"

#### ج. مشاكل في سياسات RLS

تأكد من وجود سياسات RLS مناسبة لجدول `profiles`:

1. انتقل إلى لوحة تحكم Supabase
2. انقر على "Authentication" > "Policies"
3. تحقق من سياسات جدول `profiles`
4. تأكد من وجود سياسة تسمح للمستخدمين المصادقين بقراءة ملفاتهم الشخصية

### 2. استخدام صفحة اختبار المصادقة

تم إضافة صفحة خاصة لاختبار المصادقة في المشروع. يمكنك الوصول إليها من خلال:

```
https://horusnews.vercel.app/test-auth
```

هذه الصفحة تقدم معلومات مفصلة عن:

- متغيرات البيئة
- حالة المصادقة الحالية
- إمكانية تسجيل الدخول وتسجيل الخروج للاختبار

### 3. التحقق من سجلات وحدة تحكم المتصفح

عند مواجهة مشاكل في المصادقة، افتح وحدة تحكم المتصفح (F12 > Console) لمراقبة أي أخطاء قد تظهر. تم إضافة تسجيل مفصل في الكود للمساعدة في تشخيص المشاكل.

## خطوات إضافية للتصحيح

### 1. التحقق من وجود ملف شخصي للمستخدم

بعد تسجيل الدخول، يحاول النظام جلب معلومات الملف الشخصي للمستخدم من جدول `profiles`. إذا لم يكن هناك ملف شخصي، قد تحدث مشاكل.

يمكنك التحقق من وجود ملف شخصي للمستخدم من خلال:

1. انتقل إلى لوحة تحكم Supabase
2. انقر على "Table Editor"
3. اختر جدول `profiles`
4. ابحث عن المستخدم باستخدام معرف المستخدم أو البريد الإلكتروني

إذا لم يكن هناك ملف شخصي، يمكنك إنشاء واحد يدويًا:

```sql
INSERT INTO profiles (user_id, name, role)
VALUES ('معرف-المستخدم', 'اسم المستخدم', 'user');
```

### 2. إعادة تعيين كلمة المرور

إذا كنت تشك في وجود مشكلة في كلمة المرور، يمكنك إعادة تعيينها:

1. انتقل إلى لوحة تحكم Supabase
2. انقر على "Authentication" > "Users"
3. ابحث عن المستخدم وانقر على "Reset password"
4. أدخل البريد الإلكتروني للمستخدم وانقر على "Send reset password instructions"

### 3. التحقق من إعدادات المصادقة

تأكد من تكوين إعدادات المصادقة بشكل صحيح:

1. انتقل إلى لوحة تحكم Supabase
2. انقر على "Authentication" > "Settings"
3. تأكد من تمكين "Email auth" للسماح بالمصادقة عبر البريد الإلكتروني وكلمة المرور
4. تأكد من تعيين "Site URL" إلى عنوان URL لموقعك (مثل `https://horusnews.vercel.app`)
5. تأكد من إضافة عناوين URL المسموح بها للتوجيه بعد تسجيل الدخول (مثل `https://horusnews.vercel.app/login`)

## الاتصال بالدعم

إذا استمرت المشكلة بعد اتباع جميع الخطوات المذكورة أعلاه، يمكنك الاتصال بفريق الدعم:

- البريد الإلكتروني: support@horusnews.com
- تويتر: @HorusNewsSupport
