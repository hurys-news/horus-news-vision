# دليل نشر الأخبار بالطريقة المباشرة في حورس نيوز

هذا الدليل يشرح كيفية نشر الأخبار في موقع حورس نيوز باستخدام الطريقة المباشرة بدلاً من استخدام RPC.

## المشكلة

كان هناك مشكلة في نشر الأخبار باستخدام دالة RPC (`add_news_without_rls`) حيث كانت عملية النشر تفشل ولا تكتمل.

## الحل

تم تنفيذ طريقة بديلة لنشر الأخبار باستخدام الإدراج المباشر في جدول `news` بدلاً من استخدام دالة RPC. هذه الطريقة أكثر موثوقية وأقل عرضة للمشاكل.

## كيفية استخدام الطريقة المباشرة

### 1. زر "نشر بالطريقة المباشرة"

تم إضافة زر جديد في صفحة إنشاء المحتوى يسمى "نشر بالطريقة المباشرة". هذا الزر يستخدم الوظيفة الجديدة `addNewsDirectly` لإضافة الأخبار مباشرة إلى قاعدة البيانات.

### 2. زر "نشر المحتوى" العادي

تم تعديل زر "نشر المحتوى" العادي ليستخدم الطريقة المباشرة كخطة بديلة في حالة فشل الطريقة العادية. الآن، إذا فشلت الطريقة العادية، سيحاول النظام تلقائيًا استخدام الطريقة المباشرة.

## كيف تعمل الطريقة المباشرة؟

الطريقة المباشرة تستخدم عملية `insert` مباشرة على جدول `news` بدلاً من استدعاء دالة RPC. هذا يتجاوز أي مشاكل قد تكون موجودة في دالة RPC.

```javascript
// وظيفة جديدة لإضافة الأخبار مباشرة (بديل لـ RPC)
const addNewsDirectly = async (newsData: any) => {
  try {
    console.log('محاولة إضافة خبر بالطريقة المباشرة...');
    
    // إضافة خبر جديد مباشرة إلى جدول الأخبار
    const { data, error } = await supabase
      .from('news')
      .insert([
        {
          title: newsData.title,
          excerpt: newsData.excerpt,
          content: newsData.content,
          category_id: newsData.category_id,
          image: newsData.image,
          is_top_story: newsData.is_top_story,
          is_breaking: newsData.is_breaking,
          created_at: new Date().toISOString(),
          updated_at: new Date().toISOString(),
          view_count: 0,
          tags: newsData.tags
        }
      ])
      .select();

    console.log('نتيجة إضافة الخبر بالطريقة المباشرة:', data, error);

    if (error) throw error;

    return data;
  } catch (error) {
    console.error('خطأ في إضافة الخبر بالطريقة المباشرة:', error);
    throw error;
  }
};
```

## مزايا الطريقة المباشرة

1. **بساطة أكثر**: لا تعتمد على دوال RPC معقدة
2. **أقل عرضة للأخطاء**: تقليل نقاط الفشل المحتملة
3. **سهولة التصحيح**: أخطاء أكثر وضوحًا وأسهل في التشخيص
4. **أداء أفضل**: عمليات أقل وأكثر مباشرة

## ملاحظات هامة

- إذا كنت تواجه مشاكل في سياسات RLS (Row Level Security)، فقد تحتاج إلى تعديلها للسماح بعمليات الإدراج المباشر
- تأكد من أن المستخدم لديه الصلاحيات المناسبة للكتابة في جدول `news`
- يمكنك دائمًا العودة إلى استخدام RPC إذا كنت بحاجة إلى منطق معالجة معقد لا يمكن تنفيذه من خلال عمليات الإدراج المباشر

## استكشاف الأخطاء وإصلاحها

إذا واجهت مشاكل في نشر الأخبار باستخدام الطريقة المباشرة، يمكنك التحقق من:

1. **سجلات وحدة تحكم المتصفح**: افتح وحدة تحكم المتصفح (F12 > Console) لمراقبة أي أخطاء قد تظهر
2. **سياسات RLS**: تأكد من أن سياسات RLS تسمح بعمليات الإدراج للمستخدمين المصادقين
3. **صلاحيات المستخدم**: تأكد من أن المستخدم لديه دور "admin" أو "editor"
4. **تنسيق البيانات**: تأكد من أن البيانات المرسلة تتوافق مع هيكل جدول `news`

## الخطوات التالية

إذا كنت ترغب في تحسين عملية نشر الأخبار أكثر، يمكنك:

1. إضافة المزيد من التحقق من البيانات قبل الإرسال
2. تحسين معالجة الأخطاء وعرض رسائل أكثر تفصيلاً
3. إضافة وظيفة لحفظ المسودات قبل النشر النهائي
4. تنفيذ نظام مراجعة للمحتوى قبل النشر
